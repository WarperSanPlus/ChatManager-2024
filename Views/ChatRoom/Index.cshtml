@{
    ViewBag.Title = "Index";

    int? selectId = ViewBag.CurrentChat;
    bool isAdmin = true;
}

<i id="currentId">@selectId</i>
<div id="header-container">
    @if (isAdmin)
    {
        @Helper.ImageCmd("ChatRoom", "", "~/Content/UI-Icons/chatRoom.png", "UserSmallAvatar", "Modérer les messages");
    }
    <h2>Salle de discussions</h2>
</div>
<hr />

<div id="ChatRoomContainer">
    <div id="OnlineFriendsContainer"><!-- FRIENDS --></div>
    <div id="ChatBoxContainer">
        <div>
            <!-- CHAT BOX HEADER -->
        </div>
        <div id="ChatMessagesContainer"><!-- MESSAGES --></div>
    </div>
    <div id="ChatInputContainer">
        <div id="chat-message-form">
            <input id="chat-message-input" type="text" placeholder="Tapez votre message ici ..." autocomplete="off" />
            <button id="chat-message-submit">
                <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script defer>
        var allowScroll = true;
        var currentId = $("#currentId").text();
        $("#currentId").remove();
        if (currentId == "")
            currentId = undefined;

        initTimeout(300);

        /* MESSAGES PR */
        function scrollToEnd(time) {
            let element = $("#ChatMessagesContainer>*:last-child")[0];

            if (element == undefined)
                return;

            element.scrollIntoView(false);
        }
        let onMessageRefresh = function () {

            if (allowScroll) {
                scrollToEnd(0);
                allowScroll = false;
            }
        };

        let messages = new PartialRefresh("@Url.Action("GetMessages")", "ChatMessagesContainer", 1, onMessageRefresh, currentId != undefined);
    </script>

    <script defer>
        let firstTime = true;

        /* FRIENDS PR */
        let onFriendsRefresh = function () {
            $(".chat-friend").click(function () {
                allowScroll = true;
                let isSelected = $(this).hasClass("selected");
                let userId = isSelected ? undefined : $(this).data("id");

                currentId = userId;

                // Update chat box
                messages.replaceData({
                    userId: userId
                });
                messages.refresh(true);

                // Update select
                if (firstTime)
                    $(".chat-friend").removeClass("selected");

                if (!isSelected)
                    $(this).addClass("selected");
            });

            var select = $('.chat-friend[data-id="' + currentId + '"]');
            if (firstTime) {
                select.click();
                firstTime = false;
            }
            select.addClass("selected");
        };

        let friends = new PartialRefresh("@Url.Action("GetOnlineFriends")", "OnlineFriendsContainer", 1, onFriendsRefresh, true);
    </script>

    <script defer>
        $("#chat-message-input").on("keydown", function (event) {
            if (event.key === 'Enter')
                sendMessage();
            if (event.key === "Escape") {
                $(this).blur();
                setMessageText("");
            }
        });

        function setMessageText(content) {
            $("#chat-message-input").val(content);
        }

        function sendMessage() {
            let content = $("#chat-message-input").val();
            let userId = $(".chat-friend:is(.selected)").data("id");

            messages.commandPost("@Url.Action("AddMessage")", {
                userId: userId,
                content: content
            }, function () {
                setMessageText("");
                allowScroll = true;
            });
        };

        $("#chat-message-submit").click(sendMessage);
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/Content/ChatRoomStyles.css" />
}